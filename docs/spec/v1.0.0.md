# v1.0.0 Technical Spec

## Summary

1-2 sentence summary of what this document is about and why we should work on
it.

Inspired by [Fireorm](https://github.com/wovalle/fireorm), this is a technical
overview for the implementation of a Repository API for
[Firebase Realtime Database](https://firebase.google.com/docs/database).

## Background

What is the motivation for these changes? What problems will this solve? Include
graphs, metrics, etc. if relevant.

- Prefer working with JSON data, but at present, there are no projects on NPM
  offering a Repository API for RTD
- Will be used in lieu of Fireorm for future Flex Development projects

## Goals

What are the outcomes that will result from these changes?

- GitHub Package Registry / NPM package

How will we evaluate success for the proposed changes?

- GitHub issue tracking
- Number of downloads
- Testing strategies

### Non-Goals

To narrow the scope of what we're working on, outline what this proposal will
not accomplish.

- Not client-side compatible
- Opinionated validator API — must use
  [`runtypes`](https://github.com/pelotom/runtypes) library

## Proposed Solution

Describe the solution to the problems outlined above. Include enough detail to
allow for productive discussion and comments from readers.

- **Configuration**
  - Service Account
    - `process.env.FIREBASE_CLIENT_EMAIL`
    - `process.env.FIREBASE_PRIVATE_KEY`
    - `process.env.FIREBASE_PROJECT_ID`
  - Database
    - `process.env.FIREBASE_DATABASE_URL`
  - Optional
    - `process.env.FIREBASE_RTD_REPOS_VALIDATE="true"`
- **Repository API — Inspired by the
  [TypeORM Repository API](https://github.com/typeorm/typeorm/blob/master/docs/repository-api.md)**
  - `RTDRepository<E extends IEntity = IEntity, P extends Params = Params>`
  - `constructor(path: string, model?: RunTypeBase<Record>)`
    - Throws `Exception` if missing service account or database url
  - `static request<T>(config: Omit<AxiosRequestConfig, 'baseURL'>): Promise<T>`
  - `clear(): Promise<boolean>`
  - `create(dto: EntityDTO<E>): Promise<E>`
  - `delete(id: OneOrMany<E['id']>>): Promise<typeof id>`
  - `find(params?: P): Promise<PartialOr<E>[]>`
  - `findAndCount(params?: P): Promise<FindAndCountResult<E>>`
  - `findByIds(ids: E['id'][], params?: P): Promise<PartialOr<E>[]>`
  - `findOne(id: E['id'], params?: P): Promise<PartialOr<E> | null>`
  - `findOneOrFail(id: E['id'], params?: P): Promise<PartialOr<E>>`
  - `query(params?: P): Promise<PartialOr<E>[]>`
  - `save(dto: OneOrMany<EntityDTO<E>>): Promise<OneOrMany<E>>`
  - `upsert(dto: PartialOr<EntityDTO<E>>): Promise<E>`
- **Requests — Use Firebase Database REST API to perform CRUD operations on
  database**
  - Generate Google OAuth2 token during initialization or before each request
- **Exceptions**

  - `class Exception extends Error`
  - `constructor(code: ExceptionStatus, message?: string, data?: PlainObject)`
  - `fromFirebaseError(error: FirebaseError): Exception`
  - `toJSON(): ExceptionJSON`

        ```typescript
        export interface ExceptionJSON {
          readonly className: ExceptionClassName
          readonly code: ExceptionStatus
          readonly data: PlainObject
          readonly errors?: ExceptionErrors
          readonly message: string
          readonly name: keyof typeof ExceptionStatus
        }
        ```

- **Distribution**
  - GitHub Package Registry
  - NPM (cross-publishing required)

### Risks

Highlight risks so your reviewers can direct their attention here.

- Does not support client-side applications
  - The [`googleapis`](https://github.com/googleapis/google-api-nodejs-client)
    package only supports server-side usage and will be used to generate Google
    OAuth2 tokens
- Only supports `runtypes` models
  - The first version of `rtd-repos` will only support models created using
    `runtypes`

### Milestones

Break down the solution into key tasks and their estimated deadlines.

- **Repository setup, ~1 day**
- **Development, ~2 weeks**
  - Configuration
    - `configuration.ts`
  - Library (Globals)
    - `enums/`
    - `exceptions/`
    - `interfaces/`
    - `types.ts`
  - Repositories
    - `RTDRepository`
- **Release QA, ~1 week**
  - Finish any tests marked `it.todo`
  - Review JSDoc comments
  - Review open source documentation
    - README
      - Getting Started
      - Usage
    - Contributing Guide
  - Setup cross publishing between GPR and NPM

### Open Questions

Ask any unresolved questions about the proposed solution here.

- Should a token be generated when a repo is initialized or every request?

## Follow-up Tasks

What needs to be done next for this proposal?

- Project Kickoff document
- Add tickets to roadmap
